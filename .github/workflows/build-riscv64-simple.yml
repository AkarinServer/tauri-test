name: Build RISCV64 (Simple)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-riscv64:
    name: Build for RISCV64 Linux
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build on RISCV64
        uses: uraimo/run-on-arch-action@v2.8.1
        with:
          arch: riscv64
          distro: ubuntu22.04
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          run: |
            # 更新系统（在容器中通常以 root 运行，不需要 sudo）
            apt-get update
            
            # 安装系统依赖
            apt-get install -y \
              libwebkit2gtk-4.1-dev \
              build-essential \
              curl \
              wget \
              file \
              libxdo-dev \
              libssl-dev \
              libayatana-appindicator3-dev \
              librsvg2-dev \
              pkg-config \
              ca-certificates \
              gnupg
            
            # 安装 Node.js (直接从非官方构建源下载，Node.js 没有官方 RISCV64 版本)
            # 参考: https://github.com/nodejs/unofficial-builds/tree/main/recipes/riscv64
            # 参考: https://unofficial-builds.nodejs.org/
            NODE_VERSION="22.21.1"  # Node.js 22 (使用实际存在的版本)
            NODE_ARCH="riscv64"
            NODE_DIST="node-v${NODE_VERSION}-linux-${NODE_ARCH}"
            NODE_URL="https://unofficial-builds.nodejs.org/download/release/v${NODE_VERSION}/${NODE_DIST}.tar.xz"
            
            # 下载并安装 Node.js
            cd /tmp
            wget -q "$NODE_URL" -O "${NODE_DIST}.tar.xz" || {
              echo "警告: 下载 Node.js ${NODE_VERSION} 失败，尝试其他版本..."
              NODE_VERSION="22.21.0"
              NODE_DIST="node-v${NODE_VERSION}-linux-${NODE_ARCH}"
              NODE_URL="https://unofficial-builds.nodejs.org/download/release/v${NODE_VERSION}/${NODE_DIST}.tar.xz"
              wget -q "$NODE_URL" -O "${NODE_DIST}.tar.xz" || {
                echo "警告: 22.21.0 也失败，尝试 22.20.0..."
                NODE_VERSION="22.20.0"
                NODE_DIST="node-v${NODE_VERSION}-linux-${NODE_ARCH}"
                NODE_URL="https://unofficial-builds.nodejs.org/download/release/v${NODE_VERSION}/${NODE_DIST}.tar.xz"
                wget -q "$NODE_URL" -O "${NODE_DIST}.tar.xz" || {
                  echo "错误: 无法下载 Node.js 22 for RISCV64"
                  exit 1
                }
              }
            }
            
            tar -xf "${NODE_DIST}.tar.xz"
            mv "${NODE_DIST}" /opt/nodejs
            export PATH="/opt/nodejs/bin:$PATH"
            ln -sf /opt/nodejs/bin/node /usr/local/bin/node
            ln -sf /opt/nodejs/bin/npm /usr/local/bin/npm
            ln -sf /opt/nodejs/bin/npx /usr/local/bin/npx
            
            # 验证安装
            node --version
            npm --version
            
            # 安装 Rust
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source $HOME/.cargo/env
            
            # 添加 RISCV64 目标（虽然已经在 RISCV64 上，但确保工具链完整）
            rustup target add riscv64gc-unknown-linux-gnu
            
            # 安装项目依赖
            # 确保在正确的工作目录，并检查 package-lock.json
            cd /workspace || cd /github/workspace || pwd
            if [ -f package-lock.json ]; then
              echo "找到 package-lock.json，使用 npm ci"
              npm ci
            else
              echo "警告: package-lock.json 不存在，使用 npm install"
              npm install
            fi
            
            # 确保在项目根目录
            cd /workspace || cd /github/workspace || pwd
            ls -la
            
            # 构建前端
            npm run build
            
            # 构建 Tauri 应用
            npm run tauri build -- --target riscv64gc-unknown-linux-gnu

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-riscv64-build
          path: |
            src-tauri/target/riscv64gc-unknown-linux-gnu/release/tauri-riscv64-test
            src-tauri/target/riscv64gc-unknown-linux-gnu/release/bundle/

