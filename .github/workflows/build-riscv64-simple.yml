name: Build RISCV64 (Simple)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-riscv64:
    name: Build for RISCV64 Linux
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build on RISCV64
        uses: uraimo/run-on-arch-action@v2.8.1
        with:
          arch: riscv64
          distro: ubuntu22.04
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          run: |
            # 更新系统（在容器中通常以 root 运行，不需要 sudo）
            apt-get update
            
            # 安装系统依赖
            apt-get install -y \
              libwebkit2gtk-4.1-dev \
              build-essential \
              curl \
              wget \
              file \
              libxdo-dev \
              libssl-dev \
              libayatana-appindicator3-dev \
              librsvg2-dev \
              pkg-config \
              ca-certificates \
              gnupg \
              python3 \
              python3-pip \
              make \
              gcc \
              g++
            
            # 安装 Node.js (使用 nvm，因为 NodeSource 不支持 RISCV64)
            # Node.js 官方不提供 RISCV64 预编译二进制，需要从源码编译
            export TMPDIR=/tmp
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            # 从源码编译 Node.js（这会很慢，但这是唯一的方式）
            nvm install -s 20 || nvm install -s 18 || nvm install -s 16
            nvm use 20 || nvm use 18 || nvm use 16
            
            # 安装 Rust
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source $HOME/.cargo/env
            
            # 添加 RISCV64 目标（虽然已经在 RISCV64 上，但确保工具链完整）
            rustup target add riscv64gc-unknown-linux-gnu
            
            # 安装项目依赖
            npm ci
            
            # 构建前端
            npm run build
            
            # 构建 Tauri 应用
            npm run tauri build -- --target riscv64gc-unknown-linux-gnu

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-riscv64-build
          path: |
            src-tauri/target/riscv64gc-unknown-linux-gnu/release/tauri-riscv64-test
            src-tauri/target/riscv64gc-unknown-linux-gnu/release/bundle/

