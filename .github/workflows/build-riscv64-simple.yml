name: Build RISCV64 (Simple)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-riscv64:
    name: Build for RISCV64 Linux
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build on RISCV64
        uses: uraimo/run-on-arch-action@v2.8.1
        with:
          arch: riscv64
          distro: ubuntu22.04
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          run: |
            # 更新系统（在容器中通常以 root 运行，不需要 sudo）
            apt-get update
            
            # 安装系统依赖
            apt-get install -y \
              libwebkit2gtk-4.1-dev \
              build-essential \
              curl \
              wget \
              file \
              libxdo-dev \
              libssl-dev \
              libayatana-appindicator3-dev \
              librsvg2-dev \
              pkg-config \
              ca-certificates \
              gnupg
            
            # 安装 Node.js (使用非官方构建镜像，避免从源码编译)
            # 参考: https://unofficial-builds.nodejs.org/
            export TMPDIR=/tmp
            export NVM_NODEJS_ORG_MIRROR=https://unofficial-builds.nodejs.org/download/release
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            # 优先尝试安装 Node.js 18 LTS（更可能与系统库兼容）
            # 如果非官方构建不可用，尝试从源码编译（会很慢）
            nvm install 18 --latest-npm || (export NVM_NODEJS_ORG_MIRROR=https://nodejs.org/dist && nvm install 18 --latest-npm) || nvm install 20 --latest-npm || nvm install 20
            nvm use 18 || nvm use 20
            
            # 安装 Rust
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source $HOME/.cargo/env
            
            # 添加 RISCV64 目标（虽然已经在 RISCV64 上，但确保工具链完整）
            rustup target add riscv64gc-unknown-linux-gnu
            
            # 安装项目依赖
            npm ci
            
            # 构建前端
            npm run build
            
            # 构建 Tauri 应用
            npm run tauri build -- --target riscv64gc-unknown-linux-gnu

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-riscv64-build
          path: |
            src-tauri/target/riscv64gc-unknown-linux-gnu/release/tauri-riscv64-test
            src-tauri/target/riscv64gc-unknown-linux-gnu/release/bundle/

