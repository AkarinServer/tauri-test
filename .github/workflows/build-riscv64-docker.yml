name: Build RISCV64 with Docker

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-riscv64-docker:
    name: Build Tauri App for RISCV64 (Docker)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: riscv64

      - name: Build in Docker container
        run: |
          # 使用支持 RISCV64 的 Ubuntu 容器
          docker run --platform linux/riscv64 --rm -v "$PWD:/workspace" -w /workspace ubuntu:22.04 bash -c "
            set -e
            export DEBIAN_FRONTEND=noninteractive
            
            # 更新系统
            apt-get update
            
            # 安装基础工具（包括 Python，用于从源码编译 Node.js）
            apt-get install -y \
              curl \
              wget \
              build-essential \
              pkg-config \
              ca-certificates \
              gnupg \
              python3 \
              python3-pip \
              make \
              gcc \
              g++
            
            # 安装 Node.js (使用 nvm，因为 NodeSource 不支持 RISCV64)
            # Node.js 官方不提供 RISCV64 预编译二进制，需要从源码编译
            export TMPDIR=/tmp
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
            export NVM_DIR=\"\$HOME/.nvm\"
            [ -s \"\$NVM_DIR/nvm.sh\" ] && \. \"\$NVM_DIR/nvm.sh\"
            # 从源码编译 Node.js（这会很慢，但这是唯一的方式）
            nvm install -s 20 || nvm install -s 18 || nvm install -s 16
            nvm use 20 || nvm use 18 || nvm use 16
            
            # 安装 Rust
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source \$HOME/.cargo/env
            
            # 添加 RISCV64 目标
            rustup target add riscv64gc-unknown-linux-gnu
            
            # 安装系统依赖（注意：RISCV64 仓库中可能没有所有包）
            apt-get install -y \
              libwebkit2gtk-4.1-dev \
              libgtk-3-dev \
              librsvg2-dev \
              libayatana-appindicator3-dev \
              libssl-dev \
              libxdo-dev \
              || echo '某些包可能不可用'
            
            # 安装项目依赖
            npm ci
            
            # 构建前端
            npm run build
            
            # 构建 Tauri 应用
            npm run tauri build -- --target riscv64gc-unknown-linux-gnu
          "

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-riscv64-docker
          path: |
            src-tauri/target/riscv64gc-unknown-linux-gnu/release/tauri-riscv64-test
            src-tauri/target/riscv64gc-unknown-linux-gnu/release/bundle/

