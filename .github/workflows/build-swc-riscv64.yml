name: Build SWC for RISC-V 64

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_run:
    # Trigger when sync workflow completes successfully
    workflows: ["Sync Upstream SWC"]
    types:
      - completed
    branches: [ main, master ]

jobs:
  build-riscv64:
    name: Build SWC Node.js bindings for RISC-V 64
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    # Only run if triggered by sync workflow (and it succeeded) or other events
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup QEMU for RISC-V
        uses: docker/setup-qemu-action@v3
        with:
          platforms: riscv64

      - name: Build on RISCV64
        uses: uraimo/run-on-arch-action@v3
        with:
          arch: riscv64
          distro: ubuntu24.04
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          dockerRunArgs: |
            --volume "${{ github.workspace }}:/workspace"
          run: |
            # 更新系统
            apt-get update -qq
            apt-get install -y \
              build-essential \
              curl \
              wget \
              git \
              pkg-config \
              libssl-dev \
              ca-certificates \
              gnupg \
              python3 \
              python3-pip
            
            # 安装 Node.js (RISC-V 版本)
            NODE_VERSION="24.11.0"
            NODE_ARCH="riscv64"
            NODE_DIST="node-v${NODE_VERSION}-linux-${NODE_ARCH}"
            NODE_URL="https://github.com/gounthar/unofficial-builds/releases/download/v${NODE_VERSION}/${NODE_DIST}.tar.xz"
            
            cd /tmp
            echo "Downloading Node.js ${NODE_VERSION} for RISCV64..."
            wget -q "$NODE_URL" -O "${NODE_DIST}.tar.xz" || {
              echo "Error: Failed to download Node.js"
              exit 1
            }
            
            tar -xf "${NODE_DIST}.tar.xz"
            mv "${NODE_DIST}" /opt/nodejs
            export PATH="/opt/nodejs/bin:$PATH"
            ln -sf /opt/nodejs/bin/node /usr/local/bin/node
            ln -sf /opt/nodejs/bin/npm /usr/local/bin/npm
            ln -sf /opt/nodejs/bin/npx /usr/local/bin/npx
            
            echo "Node.js version: $(node --version)"
            echo "npm version: $(npm --version)"
            
            # 安装 Rust
            echo "Installing Rust..."
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source $HOME/.cargo/env
            
            # 添加 RISC-V 目标
            rustup target add riscv64gc-unknown-linux-gnu
            echo "Rust version: $(rustc --version)"
            
            # 切换到工作目录
            cd /workspace
            echo "Current directory: $(pwd)"
            echo "Workspace contents:"
            ls -la
            
            # 检查项目结构
            if [ ! -d "bindings/node" ]; then
              echo "Error: bindings/node directory not found"
              echo "Available directories:"
              find . -maxdepth 2 -type d | head -20
              exit 1
            fi
            
            # 进入 bindings/node 目录
            cd bindings/node
            echo "Current directory: $(pwd)"
            echo "bindings/node contents:"
            ls -la
            
            # 安装 Node.js 依赖
            echo "Installing Node.js dependencies..."
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install
            fi
            
            # 检查 package.json 中的构建脚本
            echo "Package.json build scripts:"
            cat package.json | grep -A 10 '"scripts"' || echo "No scripts found"
            
            # 尝试构建
            echo "Building SWC Node.js bindings for RISC-V..."
            
            # 设置环境变量
            export CARGO_BUILD_JOBS=$(nproc || echo 4)
            export CARGO_TARGET_DIR="/workspace/target"
            export CARGO_NET_RETRY=10
            export CARGO_HTTP_TIMEOUT=300
            
            # 尝试不同的构建方式
            if npm run build 2>&1; then
              echo "✓ Build successful with 'npm run build'"
            elif npm run build:release 2>&1; then
              echo "✓ Build successful with 'npm run build:release'"
            elif npm run build:napi 2>&1; then
              echo "✓ Build successful with 'npm run build:napi'"
            else
              echo "⚠ Standard build scripts failed, trying manual build..."
              
              # 手动构建：先编译 Rust 部分，再构建 Node.js 绑定
              cd /workspace
              
              # 编译所有 Rust crates
              echo "Building Rust crates..."
              cargo build --release --target riscv64gc-unknown-linux-gnu || {
                echo "Error: Failed to build Rust crates"
                exit 1
              }
              
              # 回到 bindings/node 并尝试构建 Node.js 绑定
              cd bindings/node
              
              # 检查是否有 napi-rs 相关的构建脚本
              if [ -f "build.rs" ] || [ -f "Cargo.toml" ]; then
                echo "Found Rust build files, building with cargo..."
                cargo build --release --target riscv64gc-unknown-linux-gnu || {
                  echo "Error: Failed to build Node.js bindings"
                  exit 1
                }
              fi
              
              # 尝试使用 napi-cli 构建
              if command -v napi >/dev/null 2>&1 || npm list -g napi-cli >/dev/null 2>&1; then
                echo "Using napi-cli to build..."
                npx napi build --platform --target riscv64-unknown-linux-gnu || {
                  echo "Warning: napi-cli build failed"
                }
              fi
            fi
            
            # 查找生成的二进制文件
            echo "Searching for built binaries..."
            find /workspace -name "*.node" -type f 2>/dev/null | head -10
            find /workspace/target -name "*.node" -type f 2>/dev/null | head -10
            find bindings/node -name "*.node" -type f 2>/dev/null | head -10
            
            # 查找 binding.node 文件
            BINDING_NODE=""
            if [ -f "binding.node" ]; then
              BINDING_NODE="binding.node"
            elif [ -f "binding-linux-riscv64.node" ]; then
              BINDING_NODE="binding-linux-riscv64.node"
            elif [ -f "../target/riscv64gc-unknown-linux-gnu/release/binding.node" ]; then
              BINDING_NODE="../target/riscv64gc-unknown-linux-gnu/release/binding.node"
            else
              # 尝试查找任何 .node 文件
              BINDING_NODE=$(find . -name "*.node" -type f | head -1)
            fi
            
            if [ -n "$BINDING_NODE" ] && [ -f "$BINDING_NODE" ]; then
              echo "✓ Found binding.node: $BINDING_NODE"
              ls -lh "$BINDING_NODE"
              
              # 复制到工作目录根目录以便上传
              cp "$BINDING_NODE" /workspace/swc-riscv64.node
              echo "✓ Copied to /workspace/swc-riscv64.node"
            else
              echo "✗ Error: binding.node not found"
              echo "Searching in all locations:"
              find /workspace -name "*.node" -type f 2>/dev/null
              exit 1
            fi
            
            # 验证文件
            if [ -f "/workspace/swc-riscv64.node" ]; then
              echo "✓ Final binary file:"
              ls -lh /workspace/swc-riscv64.node
              file /workspace/swc-riscv64.node || true
            fi

      - name: Upload RISC-V binary
        uses: actions/upload-artifact@v4
        with:
          name: swc-riscv64-binding
          path: swc-riscv64.node
          retention-days: 90
          if-no-files-found: error

      - name: Create GitHub Release (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: swc-riscv64.node
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Successfully built SWC Node.js bindings for RISC-V 64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Binary file:** \`swc-riscv64.node\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Download:** Available as GitHub Actions artifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Usage:** Replace \`node_modules/@swc/core/binding.node\` with this file" >> $GITHUB_STEP_SUMMARY

