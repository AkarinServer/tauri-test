name: Build RISCV64 (Self-Hosted Runner)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-riscv64:
    name: Build for RISCV64 Linux (Self-Hosted)
    runs-on: [self-hosted, Linux, RISCV64]
    permissions:
      contents: write
    env:
      TARGET_ARCH: riscv64
      RUNNER_ARCH: riscv64
    
    steps:
      - name: Setup system libraries
        run: |
          echo "Installing required system libraries..."
          sudo apt-get update -qq
          sudo apt-get install -y libatomic1 || true
          
      - name: Check system Node.js
        run: |
          echo "Checking for system Node.js..."
          if command -v node &> /dev/null; then
            echo "System Node.js found: $(node --version)"
            echo "Node.js path: $(which node)"
            node --version
          else
            echo "No system Node.js found"
          fi
          
          # Check if runner's Node.js works
          if [ -f /home/runner/externals/node20/bin/node ]; then
            echo "Runner Node.js path: /home/runner/externals/node20/bin/node"
            /home/runner/externals/node20/bin/node --version || echo "Runner Node.js failed"
          fi
          
          # Set PATH to prefer system Node.js if available
          if command -v node &> /dev/null; then
            echo "Using system Node.js"
            echo "NODE_PATH=$(which node)" >> $GITHUB_ENV
            echo "PATH=$(dirname $(which node)):$PATH" >> $GITHUB_ENV
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for version calculation

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.rustup
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache Cargo build (target directory)
        uses: actions/cache@v4
        with:
          path: |
            src-tauri/target
          key: ${{ runner.os }}-cargo-target-riscv64-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-target-riscv64-

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Update system
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            pkg-config \
            ca-certificates \
            gnupg

      - name: Install Node.js
        run: |
          # Check if Node.js is already installed
          if command -v node &> /dev/null; then
            echo "Node.js already installed: $(node --version)"
            echo "npm version: $(npm --version)"
          else
            echo "Installing Node.js 24.11.0 from GitHub Releases..."
            NODE_VERSION="24.11.0"
            NODE_ARCH="riscv64"
            NODE_DIST="node-v${NODE_VERSION}-linux-${NODE_ARCH}"
            NODE_URL="https://github.com/gounthar/unofficial-builds/releases/download/v${NODE_VERSION}/${NODE_DIST}.tar.xz"
            
            cd /tmp
            wget -q "$NODE_URL" -O "${NODE_DIST}.tar.xz" || {
              echo "Error: Failed to download Node.js ${NODE_VERSION} for RISCV64"
              exit 1
            }
            
            tar -xf "${NODE_DIST}.tar.xz"
            sudo mv "${NODE_DIST}" /opt/nodejs
            export PATH="/opt/nodejs/bin:$PATH"
            sudo ln -sf /opt/nodejs/bin/node /usr/local/bin/node
            sudo ln -sf /opt/nodejs/bin/npm /usr/local/bin/npm
            sudo ln -sf /opt/nodejs/bin/npx /usr/local/bin/npx
            
            echo "Node.js installed: $(node --version)"
            echo "npm version: $(npm --version)"
          fi

      - name: Install Rust
        run: |
          if command -v rustc &> /dev/null; then
            echo "Rust already installed: $(rustc --version)"
          else
            echo "Installing Rust..."
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source $HOME/.cargo/env
            rustup target add riscv64gc-unknown-linux-gnu
            echo "Rust installed: $(rustc --version)"
          fi
          
          # Ensure cargo is available in subsequent steps
          echo "PATH=$HOME/.cargo/bin:$PATH" >> $GITHUB_ENV
          echo "CARGO_HOME=$HOME/.cargo" >> $GITHUB_ENV
          echo "CARGO_INCREMENTAL=1" >> $GITHUB_ENV
          
          # Optimize Cargo build settings for RISC-V
          # Use all available CPU cores for parallel compilation
          echo "CARGO_BUILD_JOBS=$(nproc || echo 4)" >> $GITHUB_ENV
          echo "CARGO_TERM_PROGRESS_WHEN=always" >> $GITHUB_ENV
          echo "CARGO_TERM_PROGRESS_WIDTH=80" >> $GITHUB_ENV
          
          # Network settings for better reliability
          echo "CARGO_NET_RETRY=10" >> $GITHUB_ENV
          echo "CARGO_HTTP_TIMEOUT=300" >> $GITHUB_ENV
          
          # Don't set CARGO_TARGET_DIR to allow Tauri to use default location
          # This makes release file paths predictable
          unset CARGO_TARGET_DIR || true

      - name: Install project dependencies
        run: |
          echo "Current directory: $(pwd)"
          ls -la
          
          # On RISC-V, we need to remove @vitejs/plugin-react-swc from package.json
          # before installing dependencies because it will try to load @swc/core
          # which doesn't have native bindings for RISC-V
          # We'll use @vitejs/plugin-react (Babel-based) instead
          if [ -f package.json ]; then
            echo "Removing @vitejs/plugin-react-swc from package.json for RISC-V build..."
            # Use node to remove the SWC plugin from package.json
            node -e "
              const fs = require('fs');
              const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
              if (pkg.devDependencies && pkg.devDependencies['@vitejs/plugin-react-swc']) {
                delete pkg.devDependencies['@vitejs/plugin-react-swc'];
                fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
                console.log('Removed @vitejs/plugin-react-swc from package.json');
              }
            "
          fi
          
          if [ -f package-lock.json ]; then
            echo "Found package-lock.json, using npm ci"
            npm ci
          else
            echo "Warning: package-lock.json not found, using npm install"
            npm install
          fi
          
          # Ensure @vitejs/plugin-react is installed (Babel-based)
          if ! npm list @vitejs/plugin-react >/dev/null 2>&1; then
            echo "Installing @vitejs/plugin-react..."
            npm install --save-dev @vitejs/plugin-react
          fi

      - name: Calculate version
        id: version
        run: |
          # Calculate version based on commit count (自动版本递增)
          # Format: 0.1.${COMMIT_COUNT}
          BASE_VERSION="0.1"
          COMMIT_COUNT=$(git rev-list --count HEAD)
          VERSION="${BASE_VERSION}.${COMMIT_COUNT}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION (based on commit count: $COMMIT_COUNT)"
          
          # Update package.json and Cargo.toml with new version (构建前更新版本)
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '$VERSION';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
            console.log('Updated package.json version to', pkg.version);
          "
          
          # Update Cargo.toml version
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" src-tauri/Cargo.toml
          echo "Updated Cargo.toml version to $VERSION"
          
          # Update tauri.conf.json version (required for correct package naming)
          node -e "
            const fs = require('fs');
            const tauriConfig = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
            tauriConfig.version = '$VERSION';
            fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(tauriConfig, null, 2) + '\n');
            console.log('Updated tauri.conf.json version to', tauriConfig.version);
          "
          
      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous release tag
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            # No previous tag, get all commits
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # Get commits since last tag
            COMMITS=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          if [ -z "$COMMITS" ]; then
            CHANGELOG="## What's Changed
          
          No significant changes in this release."
          else
            CHANGELOG="## What's Changed
          
          $COMMITS"
          fi
          
          # Output changelog (escape newlines for GitHub Actions)
          {
            echo "changelog<<EOF"
            echo "$CHANGELOG"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "Generated changelog:"
          echo "$CHANGELOG"
          
      - name: Format build date
        id: build_date
        run: |
          # Format build date in a readable format
          # Try to use UTC timezone for consistency
          if [ -n "${{ github.event.head_commit.timestamp }}" ]; then
            # Parse and format the timestamp (Linux date command)
            BUILD_DATE=$(date -u -d "${{ github.event.head_commit.timestamp }}" "+%Y-%m-%d %H:%M:%S UTC" 2>/dev/null || echo "${{ github.event.head_commit.timestamp }}")
          else
            # Fallback to current time
            BUILD_DATE=$(date -u "+%Y-%m-%d %H:%M:%S UTC")
          fi
          
          echo "date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "Formatted build date: $BUILD_DATE"

      - name: Run prebuild
        run: |
          npm run prebuild || echo "Warning: prebuild failed, continuing..."

      - name: Build Tauri application
        timeout-minutes: 120
        env:
          NODE_OPTIONS: "--max-old-space-size=2048"
        run: |
          # Build Tauri app with only deb and rpm bundles (skip appimage for RISC-V)
          # AppImage doesn't support RISC-V architecture
          # Use fast-release profile for faster builds (optimized for speed)
          # Note: Tauri's beforeBuildCommand will build frontend automatically
          # We skip the separate frontend build step to avoid duplicate builds
          echo "Starting Tauri build for RISC-V..."
          echo "Build will use fast-release profile (optimized for speed)"
          echo "Frontend will be built automatically by Tauri's beforeBuildCommand"
          echo "Using ${CARGO_BUILD_JOBS:-4} parallel jobs for Cargo compilation"
          echo "Build timeout: 120 minutes"
          
          # Build with progress monitoring
          # Cargo environment variables are already set in the Rust installation step
          npm run tauri build -- --target riscv64gc-unknown-linux-gnu --bundles deb,rpm -- --profile fast-release
          
          # Verify build output
          echo "Build output verification:"
          ls -la src-tauri/target/riscv64gc-unknown-linux-gnu/fast-release/ 2>/dev/null || echo "Fast-release directory not found"
          ls -la src-tauri/target/riscv64gc-unknown-linux-gnu/fast-release/bundle/ 2>/dev/null || echo "Bundle directory not found"
          # Also check release directory as fallback
          ls -la src-tauri/target/riscv64gc-unknown-linux-gnu/release/ 2>/dev/null || echo "Release directory not found"

      - name: Prepare release files
        id: release_files
        run: |
          # Find all release files (修复release文件上传问题)
          # Tauri builds to src-tauri/target regardless of CARGO_TARGET_DIR
          # Use fast-release directory first (since we use --profile fast-release)
          RELEASE_DIR="src-tauri/target/riscv64gc-unknown-linux-gnu/fast-release"
          
          # Fallback to release directory if fast-release doesn't exist
          if [ ! -d "$RELEASE_DIR" ]; then
            RELEASE_DIR="src-tauri/target/riscv64gc-unknown-linux-gnu/release"
          fi
          
          echo "Checking release directory: $RELEASE_DIR"
          ls -la "$RELEASE_DIR/" 2>/dev/null || echo "Release directory not found"
          ls -la "$RELEASE_DIR/bundle/" 2>/dev/null || echo "Bundle directory not found"
          
          # Create release files list
          RELEASE_FILES=()
          
          # Get current version for filtering
          CURRENT_VERSION="${{ steps.version.outputs.version }}"
          
          # DEB packages - rename to include system name (linux) before architecture
          # Only include packages with current version
          if [ -d "$RELEASE_DIR/bundle/deb" ]; then
            for file in "$RELEASE_DIR/bundle/deb"/*.deb; do
              if [ -f "$file" ]; then
                FILENAME=$(basename "$file")
                # Check if file contains current version (use -F for fixed string matching to avoid regex issues with dots)
                if echo "$FILENAME" | grep -Fq "_${CURRENT_VERSION}_"; then
                  # Rename package: RV.Verge_0.1.74_riscv64.deb -> RV.Verge_0.1.74_linux_riscv64.deb
                  # Pattern: RV.Verge_VERSION_ARCH.deb -> RV.Verge_VERSION_linux_ARCH.deb
                  DIR=$(dirname "$file")
                  # Match pattern: _VERSION_ARCH.deb and insert _linux before ARCH
                  NEW_FILENAME=$(echo "$FILENAME" | sed -E 's/_([0-9]+\.[0-9]+\.[0-9]+)_([a-z0-9]+)\.deb$/_\1_linux_\2.deb/')
                  NEW_FILE="$DIR/$NEW_FILENAME"
                  
                  if [ "$FILENAME" != "$NEW_FILENAME" ] && [ -f "$file" ]; then
                    mv "$file" "$NEW_FILE"
                    echo "✓ Renamed DEB: $FILENAME -> $NEW_FILENAME"
                    RELEASE_FILES+=("$NEW_FILE")
                  else
                    RELEASE_FILES+=("$file")
                    echo "✓ Found DEB: $FILENAME"
                  fi
                else
                  echo "⚠ Skipping DEB with different version: $FILENAME"
                fi
              fi
            done
          else
            echo "✗ DEB directory not found: $RELEASE_DIR/bundle/deb"
          fi
          
          # RPM packages - rename to include system name (linux) before architecture
          # Only include packages with current version
          if [ -d "$RELEASE_DIR/bundle/rpm" ]; then
            for file in "$RELEASE_DIR/bundle/rpm"/*.rpm; do
              if [ -f "$file" ]; then
                FILENAME=$(basename "$file")
                # Check if file contains current version (use -F for fixed string matching to avoid regex issues with dots)
                if echo "$FILENAME" | grep -Fq "-${CURRENT_VERSION}-"; then
                  # Rename package: RV.Verge-0.1.74-1.riscv64.rpm -> RV.Verge-0.1.74-1.linux.riscv64.rpm
                  # Pattern: name-VERSION-RELEASE.ARCH.rpm -> name-VERSION-RELEASE.linux.ARCH.rpm
                  DIR=$(dirname "$file")
                  # Match pattern: .ARCH.rpm and insert .linux before ARCH
                  # This handles both .riscv64.rpm and .ARCH.rpm formats
                  NEW_FILENAME=$(echo "$FILENAME" | sed -E 's/\.([a-z0-9]+)\.rpm$/.linux.\1.rpm/')
                  NEW_FILE="$DIR/$NEW_FILENAME"
                  
                  if [ "$FILENAME" != "$NEW_FILENAME" ] && [ -f "$file" ]; then
                    mv "$file" "$NEW_FILE"
                    echo "✓ Renamed RPM: $FILENAME -> $NEW_FILENAME"
                    RELEASE_FILES+=("$NEW_FILE")
                  else
                    RELEASE_FILES+=("$file")
                    echo "✓ Found RPM: $FILENAME"
                  fi
                else
                  echo "⚠ Skipping RPM with different version: $FILENAME"
                fi
              fi
            done
          else
            echo "✗ RPM directory not found: $RELEASE_DIR/bundle/rpm"
          fi
          
          # Check if files exist
          if [ ${#RELEASE_FILES[@]} -eq 0 ]; then
            echo "Error: No release files found!"
            echo "Build directory contents:"
            find "$RELEASE_DIR" -type f 2>/dev/null | head -20 || echo "Cannot list files"
            exit 1
          fi
          
          echo ""
          echo "Found ${#RELEASE_FILES[@]} release file(s):"
          for file in "${RELEASE_FILES[@]}"; do
            echo "  - $file ($(du -h "$file" | cut -f1))"
          done
          
          # Output files list (每行一个文件路径，使用multiline format)
          {
            echo "files<<EOF"
            printf '%s\n' "${RELEASE_FILES[@]}"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create or update GitHub Release (RISC-V)
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: RV Verge v${{ steps.version.outputs.version }}
          body: |
            ## RV Verge v${{ steps.version.outputs.version }}
            
            **Build Date:** ${{ steps.build_date.outputs.date }}
            **Commit:** ${{ github.sha }}
            
            ${{ steps.changelog.outputs.changelog }}
            
            ### Downloads
            
            #### RISC-V (Linux)
            
            - **Architecture:** RISCV64 (riscv64gc-unknown-linux-gnu)
            - **Built on:** Self-hosted RISCV64 runner
            - **DEB Package:** For Debian/Ubuntu based systems
            - **RPM Package:** For Red Hat/Fedora based systems
            
            #### macOS
            
            - **Architecture:** ARM64 (Apple Silicon)
            - **Built on:** GitHub Actions macOS runner
            - **DMG:** Disk image for easy installation
          files: ${{ steps.release_files.outputs.files }}
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
          generate_release_notes: false
          append_body: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rv-verge-riscv64
          path: |
            src-tauri/target/riscv64gc-unknown-linux-gnu/fast-release/bundle/
            src-tauri/target/riscv64gc-unknown-linux-gnu/release/bundle/
