name: Sync Upstream SWC

on:
  schedule:
    # Check for upstream updates every week (Monday at 00:00 UTC)
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if already up to date'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync-upstream:
    name: Sync from swc-project/swc
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout fork repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          # Check if upstream already exists
          if git remote | grep -q upstream; then
            git remote remove upstream
          fi
          git remote add upstream https://github.com/swc-project/swc.git
          git fetch upstream

      - name: Check for updates
        id: check-updates
        run: |
          # Get current branch (usually main or master)
          CURRENT_BRANCH=$(git branch --show-current || echo "main")
          echo "current_branch=$CURRENT_BRANCH" >> $GITHUB_OUTPUT
          
          # Check if there are any commits to merge
          git fetch upstream main || git fetch upstream master
          UPSTREAM_BRANCH=$(git ls-remote --heads upstream | grep -E 'refs/heads/(main|master)' | head -1 | sed 's/.*refs\/heads\///')
          echo "upstream_branch=$UPSTREAM_BRANCH" >> $GITHUB_OUTPUT
          
          # Get commit hashes
          LOCAL_COMMIT=$(git rev-parse HEAD)
          UPSTREAM_COMMIT=$(git rev-parse upstream/$UPSTREAM_BRANCH)
          
          echo "local_commit=$LOCAL_COMMIT" >> $GITHUB_OUTPUT
          echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
          
          # Check if upstream has new commits
          if [ "$LOCAL_COMMIT" != "$UPSTREAM_COMMIT" ]; then
            # Check if we're behind
            git fetch upstream $UPSTREAM_BRANCH
            if git rev-list --count HEAD..upstream/$UPSTREAM_BRANCH > 0; then
              echo "has_updates=true" >> $GITHUB_OUTPUT
              echo "✓ Upstream has new commits"
              git log --oneline HEAD..upstream/$UPSTREAM_BRANCH | head -5
            else
              echo "has_updates=false" >> $GITHUB_OUTPUT
              echo "⚠ Local is ahead or diverged"
            fi
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "✓ Already up to date with upstream"
          fi
          
          # Force sync if requested
          if [ "${{ inputs.force_sync }}" == "true" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "Force sync requested"
          fi

      - name: Merge upstream changes
        if: steps.check-updates.outputs.has_updates == 'true'
        run: |
          CURRENT_BRANCH="${{ steps.check-updates.outputs.current_branch }}"
          UPSTREAM_BRANCH="${{ steps.check-updates.outputs.upstream_branch }}"
          
          echo "Merging upstream/$UPSTREAM_BRANCH into $CURRENT_BRANCH..."
          
          # Try to merge
          git merge upstream/$UPSTREAM_BRANCH --no-edit -m "chore: sync from upstream $UPSTREAM_BRANCH" || {
            echo "⚠ Merge conflict detected, trying rebase..."
            git rebase upstream/$UPSTREAM_BRANCH || {
              echo "✗ Rebase also failed, aborting..."
              git rebase --abort || true
              git merge --abort || true
              exit 1
            }
          }

      - name: Push changes
        if: steps.check-updates.outputs.has_updates == 'true'
        run: |
          CURRENT_BRANCH="${{ steps.check-updates.outputs.current_branch }}"
          echo "Pushing to origin/$CURRENT_BRANCH..."
          git push origin $CURRENT_BRANCH || {
            echo "✗ Push failed"
            exit 1
          }
          echo "✓ Successfully synced and pushed"

      - name: Trigger build workflow
        if: steps.check-updates.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: workflows } = await github.rest.actions.listWorkflowsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const buildWorkflow = workflows.workflows.find(
              w => w.name === 'Build SWC for RISC-V 64' || w.path === '.github/workflows/build-swc-riscv64.yml'
            );
            
            if (buildWorkflow) {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: buildWorkflow.id,
                ref: context.ref,
              });
              console.log('✓ Triggered build workflow');
            } else {
              console.log('⚠ Build workflow not found');
            }

      - name: Create summary
        run: |
          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-updates.outputs.has_updates }}" == "true" ]; then
            echo "✅ **Synced from upstream**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Upstream commit:** \`${{ steps.check-updates.outputs.upstream_commit }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Local commit (before):** \`${{ steps.check-updates.outputs.local_commit }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Build workflow:** Triggered automatically" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ **Already up to date**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No new commits from upstream." >> $GITHUB_STEP_SUMMARY
          fi

